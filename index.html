<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OKR Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>OKR Dashboard</h1>
    <p class="subtitle">Team PRs, blockers, and progress overview</p>
  </header>

  <main>
  <div class="controls">
      <label for="team-select">Select partner customer:</label>
      <select id="team-select"></select>

  <!-- import UI removed: site now reads data from data.json only -->
  </div>

  <!-- Overview moved to separate home page (home.html) -->

  <div class="overview">
      <div class="teams-grid" id="teams-grid">
        <!-- Team cards injected here -->
      </div>

      <div class="details" id="details">
        <h2 id="details-title">Select a team</h2>
        <div id="details-content">
          <p>Choose a team from the dropdown or click a team card to see repo-level status.</p>
        </div>
      </div>
  </div>

  <div class="repos" id="repos-section">
      <h2>Services</h2>
      <div id="repos-list">
        <!-- Repo rows here -->
      </div>
  </div>
  </main>

  <footer>
    <small>Static OKR dashboard • Edit data in the page's script for now</small>
  </footer>

  <script>
  // Try to load external data.json located next to this page. If it fails, fall back to the embedded sample.
  let data = null;

  async function fetchData() {
    try {
      const resp = await fetch('data.json', { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const j = await resp.json();
      data = j;
      console.log('Loaded external data.json');
    } catch (err) {
      console.warn('Could not load data.json, using embedded sample data. ', err);
      // Embedded sample fallback (so the page works when opened via file://)
      data = {
        teams: [
          {
            id: 'team-a',
            name: 'Team A',
            repos: [
              { name: 'repo-a-1', prs: { in_review: 2, complete: 3, open: 1 }, blockers: ['no access'] },
              { name: 'repo-a-2', prs: { in_review: 1, complete: 4, open: 0 }, blockers: [] },
              { name: 'repo-a-3', prs: { in_review: 0, complete: 2, open: 3 }, blockers: [] },
              { name: 'repo-a-4', prs: { in_review: 1, complete: 1, open: 1 }, blockers: ['permission'] },
              { name: 'repo-a-5', prs: { in_review: 0, complete: 5, open: 0 }, blockers: [] }
            ]
          },
          {
            id: 'team-b',
            name: 'Team B',
            repos: [
              { name: 'repo-b-1', prs: { in_review: 1, complete: 1, open: 3 }, blockers: [] },
              { name: 'repo-b-2', prs: { in_review: 0, complete: 2, open: 2 }, blockers: ['no access'] },
              { name: 'repo-b-3', prs: { in_review: 2, complete: 1, open: 2 }, blockers: [] },
              { name: 'repo-b-4', prs: { in_review: 0, complete: 0, open: 5 }, blockers: [] },
              { name: 'repo-b-5', prs: { in_review: 3, complete: 2, open: 0 }, blockers: [] }
            ]
          },
          {
            id: 'team-c',
            name: 'Team C',
            repos: [
              { name: 'repo-c-1', prs: { in_review: 0, complete: 0, open: 5 }, blockers: [] },
              { name: 'repo-c-2', prs: { in_review: 1, complete: 3, open: 1 }, blockers: [] },
              { name: 'repo-c-3', prs: { in_review: 2, complete: 2, open: 1 }, blockers: ['ci failing'] },
              { name: 'repo-c-4', prs: { in_review: 0, complete: 4, open: 1 }, blockers: [] },
              { name: 'repo-c-5', prs: { in_review: 1, complete: 0, open: 4 }, blockers: [] }
            ]
          }
        ]
      };
    }
  }

  // Utilities
  function sum(arr, fn) { return arr.reduce((s, x) => s + (fn ? fn(x) : x), 0); }

  function calcTeamSummary(team) {
    const totals = { in_review: 0, complete: 0, open: 0 };
    team.repos.forEach(r => { totals.in_review += r.prs.in_review; totals.complete += r.prs.complete; totals.open += r.prs.open; });
    const totalPRs = totals.in_review + totals.complete + totals.open;
    const percentDone = totalPRs ? Math.round((totals.complete / totalPRs) * 100) : 0;
    const blockers = team.repos.flatMap(r => r.blockers.map(b => ({ repo: r.name, reason: b })));
    return { totals, totalPRs, percentDone, blockers };
  }

  // Render
  const teamSelect = document.getElementById('team-select');
  const teamsGrid = document.getElementById('teams-grid');
  const detailsTitle = document.getElementById('details-title');
  const detailsContent = document.getElementById('details-content');
  const reposList = document.getElementById('repos-list');

  function createPie(percent) {
    // returns a div with background using conic-gradient
    const pie = document.createElement('div');
    pie.className = 'pie';
    pie.style.setProperty('--p', percent + '%');
    pie.title = percent + '% complete';
    return pie;
  }

  function renderTeams() {
    teamSelect.innerHTML = '';
    teamsGrid.innerHTML = '';
    data.teams.forEach((team, idx) => {
      const opt = document.createElement('option'); opt.value = team.id; opt.textContent = team.name;
      teamSelect.appendChild(opt);

      const summary = calcTeamSummary(team);
      const card = document.createElement('div');
      card.className = 'team-card';
      card.innerHTML = `
        <h3>${team.name}</h3>
        <div class="card-row">
          <div class="pie-wrap"></div>
          <div class="card-stats">
            <div class="stat">${summary.totalPRs} PRs</div>
            <div class="stat">${summary.totals.in_review} in review</div>
            <div class="stat">${summary.totals.complete} complete</div>
          </div>
        </div>
      `;
      card.querySelector('.pie-wrap').appendChild(createPie(summary.percentDone));
      card.addEventListener('click', () => showTeam(team.id));
      teamsGrid.appendChild(card);
    });
  // default select first
  if (data.teams.length) showTeam(data.teams[0].id);
  }

  teamSelect.addEventListener('change', (e) => showTeam(e.target.value));

  function showTeam(teamId) {
    const team = data.teams.find(t => t.id === teamId);
    if (!team) return;
    teamSelect.value = team.id;
    const s = calcTeamSummary(team);
    detailsTitle.textContent = `${team.name} — ${s.percentDone}% done`;
    let blockersHtml = '';
    if (s.blockers && s.blockers.length) {
      blockersHtml = `
        <h4>Blockers</h4>
        <ul class="blockers">
          ${s.blockers.map(b => `<li><strong>${b.repo}:</strong> ${b.reason}</li>`).join('')}
        </ul>
      `;
    }

    detailsContent.innerHTML = `
      <p><strong>Total PRs:</strong> ${s.totalPRs}</p>
      <p><strong>In review:</strong> ${s.totals.in_review} • <strong>Complete:</strong> ${s.totals.complete} • <strong>Open:</strong> ${s.totals.open}</p>
      ${blockersHtml}
    `;

    // Render a simple list of services for the selected partner customer
    reposList.innerHTML = '';
    const ul = document.createElement('ul');
    ul.className = 'services-list';
    // Alphabetize services by the `service` field (fallback to repo name), case-insensitive
    const services = (team.repos || []).slice().sort((a, b) => {
      const aKey = (a.service || a.name || '').toString().trim().toLowerCase();
      const bKey = (b.service || b.name || '').toString().trim().toLowerCase();
      if (aKey < bKey) return -1;
      if (aKey > bKey) return 1;
      return 0;
    });
    services.forEach(r => {
      const li = document.createElement('li');
      if (r.pr_link) {
        const a = document.createElement('a');
        a.href = r.pr_link;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = r.name;
        li.appendChild(a);
      } else {
        li.textContent = r.name;
      }
      ul.appendChild(li);
    });
    if (ul.children.length === 0) {
      reposList.innerHTML = '<div class="no-repos">No services to show.</div>';
    } else {
      reposList.appendChild(ul);
    }
  }

  // Initialize
  (async function init(){ await fetchData(); renderTeams(); })();

  // Overview moved to home.html; no wiring here.

  // Site-wide overview
  function calcOverall() {
    const totals = { in_review: 0, complete: 0, open: 0 };
    data.teams.forEach(team => team.repos.forEach(r => { totals.in_review += r.prs.in_review; totals.complete += r.prs.complete; totals.open += r.prs.open; }));
    const totalPRs = totals.in_review + totals.complete + totals.open;
  // total PRs needed for goals: one PR needed per repo
  const totalNeeded = data.teams.reduce((acc, t) => acc + (t.repos ? t.repos.length : 0), 0);
    const metric = document.getElementById('overview-metric-select')?.value || 'complete';
    const metricCount = metric === 'open' ? totals.open : totals.complete;
    let percentDone = 0;
    if (metric === 'open') {
      // open progress = open PRs out of total PRs needed (one per repo)
      percentDone = totalNeeded ? Math.round((metricCount / totalNeeded) * 100) : 0;
    } else {
      // complete progress remains measured against total PRs (all PR states)
      percentDone = totalPRs ? Math.round((metricCount / totalPRs) * 100) : 0;
    }
    return { totals, totalPRs, totalNeeded, percentDone, metric, metricCount };
  }

  function renderOverview() {
    const el = document.getElementById('overview-progress');
    const meta = document.getElementById('overview-meta');
    if (!data || !data.teams) return;
  const s = calcOverall();
  el.style.width = s.percentDone + '%';
  el.textContent = s.percentDone + '%';
    if (s.metric === 'open') {
      meta.textContent = `${s.metricCount} open of ${s.totalNeeded} needed • ${s.totals.complete} complete • ${s.totals.in_review} in review • ${s.totals.open} open • ${s.totalPRs} total PRs`;
    } else {
      meta.textContent = `${s.metricCount} complete • ${s.totals.complete} complete • ${s.totals.in_review} in review • ${s.totals.open} open • ${s.totalPRs} total PRs`;
    }
  }

  // Import functionality removed — site loads `data.json` from the workspace.

  </script>
</body>
</html>
